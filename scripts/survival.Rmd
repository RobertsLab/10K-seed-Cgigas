---
title: 10K seed resazurin survival analysis
author: "AS Huffmyer"
date: '2024'
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    keep_tex: yes
editor_options: 
  chunk_output_type: console
---


# Set up 

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries. 
```{r}
library(tidyverse)
library(ggplot2)
library(survival)
library(readxl)
library(ggsurvfit)
library(gtsummary)
library(cardx)
library(cowplot)
```

# Read data 

Read in data. 
```{r}
data<-read_excel("data/survival/survival_resazurin.xlsx")
```

Turn into long format. 
```{r}
data<-data%>%
  pivot_longer(names_to="time", values_to="status", cols=`0`:`24`)%>%
  mutate(time=as.numeric(time))
```

Create data frames with control and high temperature subsets. 
```{r}
control<-data%>%filter(temperature=="18C")
stress<-data%>%filter(temperature=="42C")
```


# Generate Kaplan Meier survival curves 

## Control temperature 18C

```{r}
s1 <- survfit(Surv(time, status) ~ hardening, data = control)
str(s1)
```

Plot the survival function
```{r}
survfit2(Surv(time, status) ~ hardening+temperature, data = control) %>% 
  ggsurvfit() +
  labs(
    x = "Hours",
    y = "Survival probability"
  )
```

Estimate survival at 24 hours. 
```{r}
summary(survfit(Surv(time, status) ~ hardening, data = control), times = 24)
```

Estimated control survival is 87-99% in control temperature, with fresh water as the lowest mean.    

Use a log rank model to determine statistical differences in curves. 
```{r}
survdiff(Surv(time, status) ~ hardening, data = control)

#Call:
#survdiff(formula = Surv(time, status) ~ hardening, data = control)
#
#                                    N Observed Expected (O-E)^2/E (O-E)^2/V
#hardening=control                 240       10    11.67   0.23810   0.45281
#hardening=fresh-water             120        8     5.83   0.80476   1.22440
#hardening=fresh-water-temperature 120        6     5.83   0.00476   0.00724
#hardening=immune                  120        7     5.83   0.23333   0.35500
#hardening=temperature             120        4     5.83   0.57619   0.87664
#
#Chisq= 2.4  on 4 degrees of freedom, p= 0.7 
```
There is no difference in survival at 18C at p=0.7. 

Analyze again with a Cox proportional hazards model. 
```{r}
coxph(Surv(time, status) ~ hardening, data = control)

#Call:
#coxph(formula = Surv(time, status) ~ hardening, data = control)
#
#                                    coef exp(coef) se(coef)      z     p
#hardeningfresh-water              0.5344    1.7064   0.4744  1.126 0.260
#hardeningfresh-water-temperature  0.2193    1.2452   0.5164  0.425 0.671
#hardeningimmune                   0.3277    1.3878   0.4928  0.665 0.506
#hardeningtemperature             -0.2361    0.7897   0.5916 -0.399 0.690
#
#Likelihood ratio test=2.19  on 4 df, p=0.7013
#n= 720, number of events= 35  

coxph(Surv(time, status) ~ hardening, data = control) %>% 
  tbl_regression(exp = TRUE) 
```
Control is the reference level. No differences in survival at 18C. 


# Generate Kaplan Meier survival curves 

## Stress temperature 42C

```{r}
s2 <- survfit(Surv(time, status) ~ hardening, data = stress)
str(s2)
```

Plot the survival function
```{r}
survfit2(Surv(time, status) ~ hardening+temperature, data = stress) %>% 
  ggsurvfit() +
  labs(
    x = "Hours",
    y = "Survival probability"
  )
```

Estimate survival at 24 hours. 
```{r}
summary(survfit(Surv(time, status) ~ hardening, data = stress), times = 24)
```

Estimated stress survival is 15-30%. Temperature hardened is the lowest.    

Use a log rank model to determine statistical differences in curves. 
```{r}
survdiff(Surv(time, status) ~ hardening, data = stress)

#Call:
#survdiff(formula = Surv(time, status) ~ hardening, data = stress)
#
#                                    N Observed Expected (O-E)^2/E (O-E)^2/V
#hardening=control                 240       63     82.3  4.539811  11.60486
#hardening=fresh-water             120       43     41.2  0.081646   0.16697
#hardening=fresh-water-temperature 120       40     41.2  0.033063   0.06761
#hardening=immune                  120       41     41.2  0.000675   0.00138
#hardening=temperature             120       60     41.2  8.616059  17.61980
#
#Chisq= 22.6  on 4 degrees of freedom, p= 2e-04 7 
```
There is a significant difference in survival at p<0.001. 

Analyze again with a Cox proportional hazards model. 
```{r}
coxph(Surv(time, status) ~ hardening, data = stress)

#Call:
#coxph(formula = Surv(time, status) ~ hardening, data = stress)
#
#                                   coef exp(coef) se(coef)     z        p
#hardeningfresh-water             0.3556    1.4271   0.1978 1.798   0.0722
#hardeningfresh-water-temperature 0.2758    1.3175   0.2022 1.364   0.1726
#hardeningimmune                  0.2753    1.3170   0.2007 1.372   0.1700
#hardeningtemperature             0.7656    2.1503   0.1806 4.239 2.24e-05
#
#Likelihood ratio test=17.63  on 4 df, p=0.00146
#n= 720, number of events= 247  

coxph(Surv(time, status) ~ hardening, data = stress) %>% 
  tbl_regression(exp = TRUE) 
```
Control is the reference level. There is a significant difference between control and temperature hardening survival. 

# Generate plots 
 
Set theme. 
```{r}
my_theme<-theme_classic()
```

Control
```{r}
plot1<-survfit2(Surv(time, status) ~ hardening, data = control) %>% 
  ggsurvfit() +
  labs(
    x = "Hours",
    y = "Survival probability",
    title="18°C"
  )+
  ylim(0,1)+
  my_theme+
  geom_text(x=10, y=0.2, label="Cox PH p=0.70")+
  theme(legend.position="none")
```

Stress
```{r}
plot2<-survfit2(Surv(time, status) ~ hardening, data = stress) %>% 
  ggsurvfit() +
  labs(
    x = "Hours",
    y = "Survival probability",
    title = "42°C"
  )+
  ylim(0,1)+
  my_theme+
  geom_text(x=10, y=0.2, label="Cox PH p=0.001")+
  geom_text(x=10, y=0.15, label="Temp vs control p<0.001")+
  theme(legend.position="right")
```

Assemble plot
```{r}
plots<-plot_grid(plot1, plot2, rel_widths=c(0.65,1), ncol=2)

ggsave(plots, filename="figures/survival/KMcurves.png", width=10, height=4)
```


