---
title: 10K seed resazurin metabolic rate analysis
author: "AS Huffmyer"
date: '2024'
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 6
    toc_float: true
  md_document: default
  github_document: null
editor_options: 
  chunk_output_type: console
---

Interpretations tl;dr: 
- Temperature hardened oysters show less metabolic plasticity and died more under stress 
- Metabolic rates are different in stressed oysters 
- Metabolic rates are different in those that died vs those that survived under stress 
- We can measure changes in metabolism using resazurin assay

# Set up 

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries. 
```{r}
library(MASS) 
library(tidyverse)
library(ggplot2)
library(readxl)
library(cowplot)
library(lme4)
library(lmerTest)
library(car)
library(effects)
library(emmeans)
```

# Load data 

Read in resazurin data
```{r}
#read in files
main_data <- read_csv("data/resazurin/resazurin_data.csv")

main_data<-main_data%>%
  pivot_longer(names_to="time", values_to="fluorescence", cols=`0`:`4`)%>%
  mutate(time=as.numeric(time))
```

Read in survival data 
```{r}
surv<-read_excel("data/survival/survival_resazurin.xlsx")

surv<-surv%>%
  pivot_longer(names_to="time", values_to="status", cols=`0`:`24`)%>%
  mutate(time=as.numeric(time))%>%
  rename(date=date.resazurin, sample=oyster)%>%
  mutate(sample=as.character(sample))
```

Read in size data 
```{r}
size <- read_csv("data/resazurin/resazurin-size.csv")%>%select(!notes)%>%mutate(sample=as.character(sample))
```

Combine data
```{r}
main_data<-left_join(main_data, surv)

main_data<-left_join(main_data,size)
```

Add in final mortality status
```{r}
final<-surv%>%
  filter(time==24)%>%
  rename(final.mortality=status)%>%
  select(!time)

main_data<-left_join(main_data, final)
```

We now have resazurin and survival data in the data frame.  

```{r}
main_data<-main_data%>%
  mutate(final.mortality = case_when(
    final.mortality == 0 ~ "alive",
    final.mortality == 1 ~ "dead",
    TRUE ~ as.character(final.mortality)  # To handle any other values
  ))
```

# Data preparation 

Plot the data. 

```{r}
main_data%>%
  ggplot(aes(x=time, y=fluorescence, colour=temperature, group=sample))+
  facet_wrap(~bag*date)+
  geom_point()+
  geom_line()+
  theme_classic()
```

Calculate fluorescence at each time point normalized to the starting value at time 0. 

```{r}
main_data<-main_data%>%
  group_by(date, bag, sample, width.mm, length.mm)%>%
  arrange(date, bag, sample)%>%
  mutate(fluorescence.norm=fluorescence/first(fluorescence))
```

Plot again 

```{r}
main_data%>%
  ggplot(aes(x=time, y=fluorescence.norm, colour=temperature, group=sample))+
  facet_wrap(~bag*date)+
  geom_point()+
  geom_line()+
  theme_classic()
```

View blanks

```{r}
main_data%>%
  filter(type=="blank")%>%
  ggplot(aes(x=time, y=fluorescence.norm, colour=temperature, group=sample))+
  facet_wrap(~bag*date)+
  geom_point()+
  geom_line()+
  theme_classic()
```

Calculate mean change in blank at each time point. 

```{r}
blanks<-main_data%>%
  filter(type=="blank")%>%
  group_by(date, bag, temperature, time)%>%
  summarise(mean_blank=mean(fluorescence.norm))
```

View summarized blank data. 

```{r}
blanks%>%
  ggplot(aes(x=time, y=mean_blank, colour=temperature))+
  facet_wrap(~bag*date)+
  geom_point()+
  geom_line()+
  theme_classic()
```

Subtract blank values from fluorescence values for oysters. 

```{r}
main_data<-left_join(main_data, blanks)

main_data<-main_data%>%
  filter(!type=="blank")%>%
  mutate(value=fluorescence.norm-mean_blank)
```

Plot again. 

```{r}
main_data%>%
  ggplot(aes(x=time, y=value, colour=temperature, group=sample))+
  facet_wrap(~bag*date*hardening)+
  geom_point()+
  geom_line()+
  theme_classic()
```

Remove unnecessary columns. 

```{r}
main_data<-main_data%>%
  select(!type)%>%
  select(!fluorescence.norm)%>%
  select(!mean_blank)%>%
  select(!fluorescence)
```

Normalize blank corrected fluorescence to oyster size by dividing fluorescence value (normalized to starting value and blank corrected) by oyster size. Calculate volume by using length and width. 

```{r}
main_data$volume.mm3<-(4/3) * pi * ((main_data$length.mm/2) * (main_data$width.mm/2))^2

main_data$value.mm3<-main_data$value/main_data$volume.mm3
```

Plot size normalized resazurin response. 

```{r}
main_data%>%
  ggplot(aes(x=time, y=value.mm3, colour=temperature, group=sample))+
  facet_wrap(~bag*date*hardening)+
  geom_point()+
  geom_line()+
  theme_classic()
```

Plot against final mortality. 

```{r}
main_data%>%
  filter(time==4)%>%
  filter(temperature=="42C")%>%
  
  ggplot(aes(x=final.mortality, y=value.mm3, colour=final.mortality))+
  geom_violin()+
  theme_classic()

main_data%>%
  filter(time==4)%>%
  filter(temperature=="18C")%>%
  
  ggplot(aes(x=final.mortality, y=value.mm3, colour=final.mortality))+
  geom_violin()+
  theme_classic()
```

Under temperature stress, there appears to be a positive relationship between fluorescence at 4 hrs and final mortality status. This does not appear to show up at 18°C.  

Plot size and mortality relationships. 

```{r}
main_data%>%
  filter(time==4)%>%
  
  ggplot(aes(x=volume.mm3, y=final.mortality, colour=final.mortality))+
  geom_violin()+
  theme_classic()
```
Not much difference if any. 

Set time as a factor. 
```{r}
main_data$time<-as.factor(main_data$time)
```

# Analysis 

## Examine size effects 

View size range. 
```{r}
hist(main_data$volume.mm3)
```

Remove the two outlier oysters. 

```{r}
main_data<-main_data%>%
  filter(volume.mm3<150000)

hist(main_data$volume.mm3)
```

View metabolic rates over time as a function of size and temperature treatment using the non-size normalized fluorescence values. Include repeated measures for each individual. 

```{r}
model.size<-lmer(sqrt(value) ~ time * temperature * scale(volume.mm3) + (1|bag) + (1|date:bag:sample), data=main_data)

summary(model.size)
anova(model.size)
rand(model.size)

qqPlot(residuals(model.size))

plot(Effect(c("volume.mm3"), model.size))
```

There is a significant effect of time and size as well as interactions between time-temperature, time-size, and time-temperature-size. This indicates that metabolic scaling is different between temperatures. 

Plot metabolic rates (y) over time (x) with a gradient of color for size. 

```{r}
main_data%>%
  ggplot(aes(x=time, y=sqrt(value), colour=scale(volume.mm3), group=paste(date, bag, sample)))+
  facet_wrap(~temperature)+
  scale_colour_gradientn(colours=c("blue", "lightblue", "white","pink", "red"))+
  geom_point()+
  geom_line()+
  theme_classic()
```

In general there are higher rates for larger sizes. 

Model using the final time point to quantify size effects on total fluorescence change. 

```{r}
final<-main_data%>%
  filter(time=="4")
```

```{r}
model.size2<-lmer(sqrt(value) ~ temperature * scale(volume.mm3) + (1|bag), data=main_data)

summary(model.size2)
anova(model.size2)
rand(model.size2)

qqPlot(residuals(model.size2))

plot(Effect(c("volume.mm3"), model.size2))
```

Temperature and size affect metabolic rate. 

Plot metabolic rates (y) over size range (x). 

```{r}
final%>%
  
  ggplot(aes(x=volume.mm3, y=sqrt(value)))+
  #facet_wrap(~temperature)+
  geom_point()+
  geom_smooth(method="lm")+
  theme_classic()
```

There is a positive relationship between metabolic rate and size, but it is not particularly strong. 

Plot correlation plot. 

18°C
```{r}
correlation18C <- lm(sqrt(value) ~ volume.mm3, data = final%>%filter(temperature=="18C"))

corrplot18C<-ggplot(final%>%filter(temperature=="18C"), aes(x = volume.mm3, y = sqrt(value))) +
      geom_point() + 
      geom_smooth(method = "lm", se = TRUE) + 
      theme_classic()+
      labs(title = "y=8.101e-06 + 1.631 (18°C)");corrplot18C
  
      
correlation42C <- lm(sqrt(value) ~ volume.mm3, data = final%>%filter(temperature=="42C"))

corrplot42C<-ggplot(final%>%filter(temperature=="42C"), aes(x = volume.mm3, y = sqrt(value))) +
      geom_point() + 
      geom_smooth(method = "lm", se = TRUE) + 
      theme_classic()+
      labs(title = "y=5.773e-06 + 1.233 (42°C)");corrplot42C
    
  
```

Size is important to consider, so we will normalize metabolic rates to size using value.mm3 generated above. 

## Model effects of time, hardening, and temperature

```{r}
data<-main_data
```


### Detect outliers 

Build a model including all predictors. 
```{r}
model<-lmer(value.mm3 ~ time * temperature * hardening + (1|bag) + (1|date:bag:sample), data=data)

qqPlot(residuals(model))

hist(data$value.mm3)
```

Identify using standardized residuals. 
```{r}
# Extract raw residuals
data$raw_resid <- residuals(model)

# Standardize residuals
data$std_resid <- data$raw_resid / sd(data$raw_resid)

# Flag potential outliers
outlier_threshold <- 3
data$outlier_flag <- abs(data$std_resid) > outlier_threshold

# Filter rows flagged as outliers
outliers <- data %>% filter(outlier_flag == TRUE)
print(outliers)

# Plot standardized residuals
ggplot(data, aes(x = seq_along(std_resid), y = std_resid)) +
  geom_point(aes(color = outlier_flag), size = 2) +
  geom_hline(yintercept = c(-outlier_threshold, outlier_threshold), linetype = "dashed", color = "red") +
  labs(title = "Standardized Residuals with Outliers", x = "Index", y = "Standardized Residual") +
  theme_minimal()
```

Remove identified outliers. 
```{r}
data<-data%>%
  filter(!outlier_flag==TRUE)
```

```{r}
hist(data$value.mm3)
```

Manually remove outlier of 1 high observation in temperature hardened oysters (alive) at 42°C at the final time point.  

```{r}
data<-data%>%
  filter(!c(time=="4"& hardening=="temperature" & final.mortality=="alive" & temperature=="42C" & value.mm3>0.0001))
```

### Analyze model  

Plot raw data. 
```{r}
data%>%
  ggplot(aes(x=time, y=value.mm3, colour=temperature, group=sample))+
  facet_wrap(~bag*date*hardening)+
  geom_point()+
  geom_line()+
  theme_classic()
```

```{r}
model<-lmer(sqrt(value.mm3) ~ time * temperature * hardening + (1|hardening:bag) + (1|date:bag:sample), data=data)

summary(model)
anova(model)
rand(model)

qqPlot(residuals(model))
```

Significant effects of time x temperature x hardening, indicating different slopes in metabolic rate between temperatures modulated by hardening treatment. 

### Plot data 

Plot mean response for each hardening treatment across time at 18°C and 42°C. 

Plot first with individual points with geom smooth lines. 

```{r}
plot1<-data%>%

  ggplot(aes(x=time, y=value.mm3, color=temperature, fill=temperature))+
  facet_grid(~hardening)+
  geom_point(alpha=0.5)+
  geom_smooth(aes(group=temperature))+
  scale_colour_manual(values=c("cyan4", "orange"))+
  scale_fill_manual(values=c("cyan4", "orange"))+
  theme_classic()+
  xlab("Hour");plot1

plot1a<-data%>%

  ggplot(aes(x=time, y=value.mm3, color=hardening, fill=hardening))+
  facet_grid(~temperature)+
  geom_point(alpha=0.5)+
  geom_smooth(aes(group=hardening))+
  #scale_colour_manual(values=c("cyan4", "orange"))+
  #scale_fill_manual(values=c("cyan4", "orange"))+
  theme_classic()+
  xlab("Hour");plot1a
```

Next plot with mean and sem for each group. 

```{r}
plot2<-data%>%
  group_by(temperature, hardening, time)%>%
  summarize(mean=mean(value.mm3, na.rm=TRUE), se=sd(value.mm3, na.rm=TRUE)/sqrt(length(value.mm3)))%>%

  ggplot(aes(x=time, y=mean, color=temperature, fill=temperature))+
  facet_grid(~hardening)+
  geom_point(alpha=0.5)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.1)+
  geom_line(aes(group=temperature))+
  scale_colour_manual(values=c("cyan4", "orange"))+
  scale_fill_manual(values=c("cyan4", "orange"))+
  theme_classic()+
  xlab("Hour");plot2

plot2a<-data%>%
  group_by(temperature, hardening, time)%>%
  summarise(mean=mean(value.mm3, na.rm=TRUE), se=sd(value.mm3, na.rm=TRUE)/sqrt(length(value.mm3)))%>%

  ggplot(aes(x=time, y=mean, color=hardening, fill=hardening))+
  facet_grid(~temperature)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.1)+
  geom_point(alpha=0.5)+
  geom_line(aes(group=hardening))+
  #scale_colour_manual(values=c("cyan4", "orange"))+
  #scale_fill_manual(values=c("cyan4", "orange"))+
  theme_classic()+
  xlab("Hour");plot2a
```

### Conduct post hoc tests

#### Effects of hardening treatment within temperature 
```{r}
anova(model)

emm<-emmeans(model, ~hardening|temperature|time, adjust = "tukey")
pairs(emm)

```

Significant effects: 

- Time 4 at 18°C: Immune higher than control and fresh-water-temperature. 

No differences at 42°C are significant.  

#### Effects of temperature treatment within hardening  
```{r}
emm<-emmeans(model, ~temperature|hardening|time, adjust = "tukey")
pairs(emm)
```

Significant effects: 

- Time 1: Control lower at 18°C
- Time 2: Fresh-water-temperature and immune lower at 42°C
- Time 3: All groups lower at 42°C
- Time 4: All groups lower at 42°C 

## Model at time final without mortality status 

### Detect outliers 

Build a model including all predictors. 
```{r}
final<-data%>%
  filter(time==4)

model2<-lmer(sqrt(value.mm3) ~ temperature * hardening + (1|hardening:bag), data=final)
summary(model2)

qqPlot(residuals(model2))

hist(final$value.mm3)
```

Identify using standardized residuals. 
```{r}
# Extract raw residuals
final$raw_resid <- residuals(model2)

# Standardize residuals
final$std_resid <- final$raw_resid / sd(final$raw_resid)

# Flag potential outliers
outlier_threshold <- 3
final$outlier_flag <- abs(final$std_resid) > outlier_threshold

# Filter rows flagged as outliers
outliers <- final %>% filter(outlier_flag == TRUE)
print(outliers)

# Plot standardized residuals
ggplot(final, aes(x = seq_along(std_resid), y = std_resid)) +
  geom_point(aes(color = outlier_flag), size = 2) +
  geom_hline(yintercept = c(-outlier_threshold, outlier_threshold), linetype = "dashed", color = "red") +
  labs(title = "Standardized Residuals with Outliers", x = "Index", y = "Standardized Residual") +
  theme_minimal()
```

No outliers detected. 

```{r}
hist(final$value.mm3)
```

### Analyze model 

Plot raw data. 
```{r}
final%>%
  ggplot(aes(x=hardening, y=value.mm3, colour=temperature, group=sample))+
  geom_point()+
  theme_classic()
```

Analyze total change in fluorescence (fluorescence after 4 hours).  

```{r}
model2<-lmer(sqrt(value.mm3) ~ temperature * hardening + (1|hardening:bag), data=final)

summary(model2)
anova(model2)
rand(model2)

qqPlot(residuals(model2))
```

### Plot data 

Plot mean response for each hardening treatment at 18°C and 42°C. 

Plot first with individual points. 

```{r}
plot3<-final%>%

  ggplot(aes(x=hardening, y=value.mm3, color=temperature))+
  geom_boxplot(position=position_dodge(0.5))+
  geom_point(alpha=0.5, position=position_dodge(0.5))+
  scale_colour_manual(values=c("cyan4", "orange"))+
  theme_classic()+
  xlab("Hardening Treatment");plot3

plot3a<-final%>%

  ggplot(aes(x=temperature, y=value.mm3, color=hardening))+
  geom_boxplot(position=position_dodge(0.9))+
  geom_point(alpha=0.5, position=position_dodge(0.9))+
  #scale_colour_manual(values=c("cyan4", "orange"))+
  theme_classic()+
  xlab("Temperature");plot3a
```

Next plot with mean and sem for each group. 

```{r}
plot4<-final%>%
  group_by(temperature, hardening)%>%
  summarise(mean=mean(value.mm3, na.rm=TRUE), se=sd(value.mm3, na.rm=TRUE)/sqrt(length(value.mm3)))%>%

  ggplot(aes(x=hardening, y=mean, color=temperature, fill=temperature))+
  geom_point(alpha=0.5)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.1)+
  scale_colour_manual(values=c("cyan4", "orange"))+
  scale_fill_manual(values=c("cyan4", "orange"))+
  theme_classic()+
  xlab("Hardening Treatment");plot4

plot4a<-final%>%
  group_by(temperature, hardening)%>%
  summarise(mean=mean(value.mm3, na.rm=TRUE), se=sd(value.mm3, na.rm=TRUE)/sqrt(length(value.mm3)))%>%

  ggplot(aes(x=temperature, y=mean, color=hardening, fill=hardening))+
  geom_point(alpha=0.5, position=position_dodge(0.7))+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.1, position=position_dodge(0.7))+
  #scale_colour_manual(values=c("cyan4", "orange"))+
  #scale_fill_manual(values=c("cyan4", "orange"))+
  theme_classic()+
  xlab("Temperature");plot4a
```

### Conduct posthoc tests 

#### Effects of hardening treatment within temperature 
```{r}
anova(model2)

emm<-emmeans(model2, ~hardening|temperature, adjust = "tukey")
pairs(emm)

```

Significant effects: 

- 18°C: Immune higher than control

No differences at 42°C are significant.  

#### Effects of temperature treatment within hardening  
```{r}
emm<-emmeans(model, ~temperature|hardening, adjust = "tukey")
pairs(emm)

```

Significant effects: 

- Control is different between temperatures
- Fresh water, fresh water temperature, immune, and temperature hardening are all lower at 42°C

## Model at time final with mortality status 

### Detect outliers 

Build a model including all predictors. 
```{r}
final_mort<-data%>%
  filter(time==4)

model3<-lmer(sqrt(value.mm3) ~ temperature * hardening * final.mortality + (1|hardening:bag), data=final_mort)

qqPlot(residuals(model3))

hist(final_mort$value.mm3)
```

Identify using standardized residuals. 
```{r}
# Extract raw residuals
final_mort$raw_resid <- residuals(model3)

# Standardize residuals
final_mort$std_resid <- final_mort$raw_resid / sd(final_mort$raw_resid)

# Flag potential outliers
outlier_threshold <- 3
final_mort$outlier_flag <- abs(final_mort$std_resid) > outlier_threshold

# Filter rows flagged as outliers
outliers <- final_mort %>% filter(outlier_flag == TRUE)
print(outliers)

# Plot standardized residuals
ggplot(final_mort, aes(x = seq_along(std_resid), y = std_resid)) +
  geom_point(aes(color = outlier_flag), size = 2) +
  geom_hline(yintercept = c(-outlier_threshold, outlier_threshold), linetype = "dashed", color = "red") +
  labs(title = "Standardized Residuals with Outliers", x = "Index", y = "Standardized Residual") +
  theme_minimal()
```

No outliers detected, use the "final" data frame since no observations needed to be removed.  

```{r}
hist(final$value.mm3)
```

### Analyze model 

Plot raw data. 
```{r}
final%>%
  ggplot(aes(x=hardening, y=value.mm3, colour=temperature, group=sample))+
  facet_wrap(~final.mortality)+
  geom_point(position=position_dodge(0.5))+
  theme_classic()
```

Analyze total change in fluorescence (fluorescence after 4 hours) for each treatment and comparing those that ended up alive or dead at the end of the trial.    

```{r}
model3<-lmer(sqrt(value.mm3) ~ temperature * hardening * final.mortality + (1|hardening:bag), data=final)

summary(model3)
anova(model3)
rand(model3)

qqPlot(residuals(model3))
```
Significant effects of temperature x hardening and temperature x mortality. Metabolic rate depending on mortality is not different between hardening treatments (no hardening x mortality).  

### Plot data 

Plot mean response for each hardening treatment at 18°C and 42°C between oysters that ended up alive and dead by the end of the trial.  

Plot first with individual points. 

```{r}
plot5<-final%>%

  ggplot(aes(x=hardening, y=value.mm3, color=final.mortality))+
  facet_grid(~temperature)+
  geom_boxplot(position=position_dodge(0.5))+
  geom_point(alpha=0.5, position=position_dodge(0.5))+
  scale_colour_manual(values=c("darkgray", "darkred"))+
  theme_classic()+
  xlab("Hardening Treatment");plot5

plot5a<-final%>%

  ggplot(aes(x=hardening, y=value.mm3, color=temperature))+
  facet_grid(~final.mortality)+
  geom_boxplot(position=position_dodge(0.9))+
  geom_point(alpha=0.5, position=position_dodge(0.9))+
  scale_colour_manual(values=c("cyan4", "orange"))+
  theme_classic()+
  xlab("Temperature");plot5a

plot5b<-final%>%

  ggplot(aes(x=final.mortality, y=value.mm3, color=temperature))+
  facet_grid(~hardening)+
  geom_boxplot(position=position_dodge(0.9))+
  geom_point(alpha=0.5, position=position_dodge(0.9))+
  scale_colour_manual(values=c("cyan4", "orange"))+
  theme_classic()+
  xlab("Final Mortality");plot5b
```

Next plot with mean and sem for each group. 

```{r}
plot6<-final%>%
  group_by(hardening, final.mortality, temperature)%>%
  summarise(mean=mean(value.mm3, na.rm=TRUE), se=sd(value.mm3, na.rm=TRUE)/sqrt(length(value.mm3)))%>%

  ggplot(aes(x=hardening, y=mean, color=final.mortality))+
  facet_grid(~temperature)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.1, position=position_dodge(0.5))+
  geom_point(alpha=0.5, position=position_dodge(0.5))+
  scale_colour_manual(values=c("darkgray", "darkred"))+
  theme_classic()+
  xlab("Hardening Treatment");plot6

plot6a<-final%>%
  group_by(hardening, final.mortality, temperature)%>%
  summarise(mean=mean(value.mm3, na.rm=TRUE), se=sd(value.mm3, na.rm=TRUE)/sqrt(length(value.mm3)))%>%

  ggplot(aes(x=hardening, y=mean, color=temperature))+
  facet_grid(~final.mortality)+
  geom_point(alpha=0.5, position=position_dodge(0.9))+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.1, position=position_dodge(0.9))+
  scale_colour_manual(values=c("cyan4", "orange"))+
  theme_classic()+
  xlab("Hardening");plot6a

plot6b<-final%>%
  group_by(hardening, final.mortality, temperature)%>%
  summarise(mean=mean(value.mm3, na.rm=TRUE), se=sd(value.mm3, na.rm=TRUE)/sqrt(length(value.mm3)))%>%

  ggplot(aes(x=final.mortality, y=mean, color=temperature))+
  facet_grid(~hardening)+
  geom_line(aes(group=temperature), position=position_dodge(0.9))+
  geom_point(alpha=0.5, position=position_dodge(0.9))+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.1, position=position_dodge(0.9))+
  scale_colour_manual(values=c("cyan4", "orange"))+
  theme_classic()+
  xlab("Final Mortality");plot6b
```

### Conduct posthoc tests 

#### Effects of mortality within temperature and hardening treatment
```{r}
anova(model3)

emm<-emmeans(model3, ~final.mortality|temperature|hardening, adjust = "tukey")
pairs(emm)
```

Significant effects: 

- Fresh water at 42°C had higher rates if the oyster died 
- Fresh water temperature at 42°C had higher rates if the oyster died
- Immune at 42°C had higher rates if the oyster died
- Tempreature at 42°C had higher rates if oysters died 

Control oysters did NOT have higher metabolic rates if the oyster died. 
No difference in alive vs dead oysters at 18°C. 

## Model mortality effects at time final for 18°C oysters 

### Detect outliers 

Build a model including all predictors. 
```{r}
final_18C<-data%>%
  filter(time==4)%>%
  filter(temperature=="18C")

model4<-lmer(sqrt(value.mm3) ~ hardening * final.mortality + (1|hardening:bag), data=final_18C)

qqPlot(residuals(model4))

hist(final_18C$value.mm3)
```

Identify using standardized residuals. 
```{r}
# Extract raw residuals
final_18C$raw_resid <- residuals(model4)

# Standardize residuals
final_18C$std_resid <- final_18C$raw_resid / sd(final_18C$raw_resid)

# Flag potential outliers
outlier_threshold <- 3
final_18C$outlier_flag <- abs(final_18C$std_resid) > outlier_threshold

# Filter rows flagged as outliers
outliers <- final_18C %>% filter(outlier_flag == TRUE)
print(outliers)

# Plot standardized residuals
ggplot(final_18C, aes(x = seq_along(std_resid), y = std_resid)) +
  geom_point(aes(color = outlier_flag), size = 2) +
  geom_hline(yintercept = c(-outlier_threshold, outlier_threshold), linetype = "dashed", color = "red") +
  labs(title = "Standardized Residuals with Outliers", x = "Index", y = "Standardized Residual") +
  theme_minimal()
```

No outliers detected. 

```{r}
hist(final_18C$value.mm3)
```

### Analyze model 

Plot raw data. 
```{r}
final_18C%>%
  ggplot(aes(x=hardening, y=value.mm3, colour=final.mortality, group=sample))+
  geom_point(position=position_dodge(0.5))+
  theme_classic()
```

Analyze total change in fluorescence (fluorescence after 4 hours) and comparing those that ended up alive or dead at the end of the trial.    

```{r}
model4<-lmer(sqrt(value.mm3) ~ hardening * final.mortality + (1|hardening:bag), data=final_18C)

summary(model4)
anova(model4)
rand(model4)

qqPlot(residuals(model4))
```
 
No significant effects. 

### Plot data 

Plot mean response for each hardening treatment between oysters that ended up alive and dead by the end of the trial at 18°C.  

Plot first with individual points. 

```{r}
plot7<-final_18C%>%

  ggplot(aes(x=hardening, y=value.mm3, color=final.mortality))+
  geom_boxplot(position=position_dodge(0.5))+
  geom_point(alpha=0.5, position=position_dodge(0.5))+
  scale_colour_manual(values=c("darkgray", "darkred"))+
  theme_classic()+
  xlab("Hardening Treatment");plot7

plot7a<-final_18C%>%

  ggplot(aes(x=temperature, y=value.mm3, color=hardening))+
  geom_boxplot(position=position_dodge(0.9))+
  geom_point(alpha=0.5, position=position_dodge(0.9))+
  theme_classic()+
  xlab("Temperature");plot7a
```

Next plot with mean and sem for each group. 

```{r}
plot8<-final_18C%>%
  group_by(hardening, final.mortality)%>%
  summarise(mean=mean(value.mm3, na.rm=TRUE), se=sd(value.mm3, na.rm=TRUE)/sqrt(length(value.mm3)))%>%
  
  ggplot(aes(x=hardening, y=mean, color=final.mortality))+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.1, position=position_dodge(0.5))+
  geom_point(alpha=0.5, position=position_dodge(0.5))+
  scale_colour_manual(values=c("darkgray", "darkred"))+
  theme_classic()+
  xlab("Hardening Treatment");plot8

plot8a<-final_18C%>%
  group_by(hardening, final.mortality)%>%
  summarise(mean=mean(value.mm3, na.rm=TRUE), se=sd(value.mm3, na.rm=TRUE)/sqrt(length(value.mm3)))%>%

  ggplot(aes(x=final.mortality, y=mean, color=hardening))+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.1, position=position_dodge(0.1))+
  geom_point(alpha=0.5, position=position_dodge(0.1))+
  geom_line(aes(group=hardening))+
  theme_classic()+
  xlab("Final Mortality");plot8a
```

### Conduct posthoc tests 

#### Effects of mortality within hardening treatment
```{r}
anova(model4)

emm<-emmeans(model4, ~final.mortality|hardening, adjust = "tukey")
pairs(emm)
```

No differences. 


## Model mortality effects at time final for 42°C oysters 

### Detect outliers 

Build a model including all predictors. 
```{r}
final_42C<-data%>%
  filter(time==4)%>%
  filter(temperature=="42C")

model5<-lmer(sqrt(value.mm3) ~ hardening * final.mortality + (1|hardening:bag), data=final_42C)

qqPlot(residuals(model5))

hist(final_42C$value.mm3)
```

Identify using standardized residuals. 
```{r}
# Extract raw residuals
final_42C$raw_resid <- residuals(model5)

# Standardize residuals
final_42C$std_resid <- final_42C$raw_resid / sd(final_42C$raw_resid)

# Flag potential outliers
outlier_threshold <- 3
final_42C$outlier_flag <- abs(final_42C$std_resid) > outlier_threshold

# Filter rows flagged as outliers
outliers <- final_42C %>% filter(outlier_flag == TRUE)
print(outliers)

# Plot standardized residuals
ggplot(final_42C, aes(x = seq_along(std_resid), y = std_resid)) +
  geom_point(aes(color = outlier_flag), size = 2) +
  geom_hline(yintercept = c(-outlier_threshold, outlier_threshold), linetype = "dashed", color = "red") +
  labs(title = "Standardized Residuals with Outliers", x = "Index", y = "Standardized Residual") +
  theme_minimal()
```

```{r}
hist(final_42C$value.mm3)
```

### Analyze model 

Plot raw data. 
```{r}
final_42C%>%
  ggplot(aes(x=hardening, y=value.mm3, colour=final.mortality, group=sample))+
  geom_point(position=position_dodge(0.5))+
  theme_classic()
```

Analyze total change in fluorescence (fluorescence after 4 hours) and comparing those that ended up alive or dead at the end of the trial.    

```{r}
model5<-lmer(sqrt(value.mm3) ~ hardening * final.mortality + (1|hardening:bag), data=final_42C)

summary(model5)
anova(model5)
rand(model5)

qqPlot(residuals(model5))
```
 
Significant effect of mortality on metabolic rates at 42°C. 

### Plot data 

Plot mean response for each hardening treatment between oysters that ended up alive and dead by the end of the trial at 18°C.  

Plot first with individual points. 

```{r}
plot9<-final_42C%>%

  ggplot(aes(x=hardening, y=value.mm3, color=final.mortality))+
  geom_boxplot(position=position_dodge(0.5))+
  geom_point(alpha=0.5, position=position_dodge(0.5))+
  scale_colour_manual(values=c("darkgray", "darkred"))+
  theme_classic()+
  xlab("Hardening Treatment");plot9

plot9a<-final_42C%>%

  ggplot(aes(x=temperature, y=value.mm3, color=hardening))+
  geom_boxplot(position=position_dodge(0.9))+
  geom_point(alpha=0.5, position=position_dodge(0.9))+
  theme_classic()+
  xlab("Temperature");plot9a
```

Next plot with mean and sem for each group. 

```{r}
plot9<-final_42C%>%
  group_by(hardening, final.mortality)%>%
  summarise(mean=mean(value.mm3, na.rm=TRUE), se=sd(value.mm3, na.rm=TRUE)/sqrt(length(value.mm3)))%>%
  
  ggplot(aes(x=hardening, y=mean, color=final.mortality))+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.1, position=position_dodge(0.5))+
  geom_point(alpha=0.5, position=position_dodge(0.5))+
  scale_colour_manual(values=c("darkgray", "darkred"))+
  theme_classic()+
  xlab("Hardening Treatment");plot9

plot9a<-final_42C%>%
  group_by(hardening, final.mortality)%>%
  summarise(mean=mean(value.mm3, na.rm=TRUE), se=sd(value.mm3, na.rm=TRUE)/sqrt(length(value.mm3)))%>%

  ggplot(aes(x=final.mortality, y=mean, color=hardening))+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.1, position=position_dodge(0.1))+
  geom_point(alpha=0.5, position=position_dodge(0.1))+
  geom_line(aes(group=hardening), position=position_dodge(0.1))+
  theme_classic()+
  xlab("Final Mortality");plot9a
```

### Conduct posthoc tests 

#### Effects of mortality within hardening treatment
```{r}
anova(model5)

emm<-emmeans(model5, ~final.mortality|hardening, adjust = "tukey")
pairs(emm)
```

All treatments have higher metabolic rates in oysters that died at 42°C (control is P=0.05 when rounded).   

## Model with hardening effects as a random effect: effects of time without mortality status 

### Load original data frame that does not have outliers removed from above 

```{r}
head(main_data)

data2<-main_data
```

### Detect outliers 

Build a model including all predictors. 
```{r}
model6<-lmer(sqrt(value.mm3) ~ time * temperature + (1|hardening:bag) + (1|hardening), data=data2)

qqPlot(residuals(model6))

hist(data2$value.mm3)
```

Identify using standardized residuals. 
```{r}
# Extract raw residuals
data2$raw_resid <- residuals(model6)

# Standardize residuals
data2$std_resid <- data2$raw_resid / sd(data2$raw_resid)

# Flag potential outliers
outlier_threshold <- 3
data2$outlier_flag <- abs(data2$std_resid) > outlier_threshold

# Filter rows flagged as outliers
outliers <- data2 %>% filter(outlier_flag == TRUE)
print(outliers)

# Plot standardized residuals
ggplot(data2, aes(x = seq_along(std_resid), y = std_resid)) +
  geom_point(aes(color = outlier_flag), size = 2) +
  geom_hline(yintercept = c(-outlier_threshold, outlier_threshold), linetype = "dashed", color = "red") +
  labs(title = "Standardized Residuals with Outliers", x = "Index", y = "Standardized Residual") +
  theme_minimal()
```

Remove outliers 

```{r}
data2<-data2%>%
  filter(!outlier_flag == TRUE)
```

```{r}
hist(data2$value.mm3)
```

16 outlier points removed.  

### Analyze model 

Plot raw data. 
```{r}
data2%>%
  ggplot(aes(x=time, y=value.mm3, colour=temperature, group=sample))+
  facet_wrap(~date)+
  geom_point()+
  geom_line(aes(group=sample))+
  theme_classic()
```

Analyze change in fluorescence over time between temperatures.    

```{r}
model6<-lmer(sqrt(value.mm3) ~ time * temperature + (1|hardening:bag) + (1|hardening), data=data2)

summary(model6)
anova(model6)
rand(model6)

qqPlot(residuals(model6))
```
 
Significant effect of temperature on metabolic rates.  

### Plot data 

Plot temperature effects over time.    

Plot first with individual points. 

```{r}
plot10<-data2%>%

  ggplot(aes(x=time, y=sqrt(value.mm3), color=temperature, fill=temperature))+
  geom_point(alpha=0.1, position=position_dodge(0.2))+
  stat_smooth(aes(group=temperature), method = "loess")+
  scale_colour_manual(values=c("cyan4", "orange"))+
  scale_fill_manual(values=c("cyan4", "orange"))+
  theme_classic()+
  ylab(expression(bold(paste(sqrt("Fluorescence units mm" ^-2)))))+
  xlab("Hours")+
  theme(
    legend.title=element_blank(),
    axis.text=element_text(size=14, colour="black"), 
    axis.title=element_text(size=14, face="bold", colour="black")
  );plot10

ggsave(plot10, filename="figures/resazurin/temp_effects.png", width=5, height=5)
```

Next plot with mean and sem for each group. 

```{r}
plot11<-data2%>%
  group_by(time, temperature)%>%
  summarise(mean=mean(value.mm3, na.rm=TRUE), se=sd(value.mm3, na.rm=TRUE)/sqrt(length(value.mm3)))%>%
  
  ggplot(aes(x=time, y=mean, color=temperature))+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.1, position=position_dodge(0.5))+
  geom_point(alpha=0.5, position=position_dodge(0.5))+
  scale_colour_manual(values=c("cyan4", "orange"))+
  theme_classic()+
  xlab("Hours");plot11
```

### Conduct posthoc tests 

#### Effects of temperature within time point
```{r}
anova(model6)

emm<-emmeans(model6, ~temperature|time, adjust = "tukey")
pairs(emm)
```

Metabolic rates are higher under 42°C in the first hour, and are lower afterwards.    



## Model with hardening effects as a random effect: effects of time with mortality status over time 

### Load original data frame that does not have outliers removed from above 

```{r}
head(main_data)

data3<-main_data
```

Plot mortality over time. 
```{r}
data3%>%
  ggplot(aes(x=time, y=status))+
  facet_wrap(~temperature)+
  geom_violin()+
  theme_classic()
```

### Detect outliers 

Build a model including all predictors. 
```{r}
model7<-lmer(sqrt(value.mm3) ~ time * temperature * status + (1|hardening:bag) + (1|hardening), data=data3)

qqPlot(residuals(model7))

hist(data3$value.mm3)
```

Identify using standardized residuals. 
```{r}
# Extract raw residuals
data3$raw_resid <- residuals(model7)

# Standardize residuals
data3$std_resid <- data3$raw_resid / sd(data3$raw_resid)

# Flag potential outliers
outlier_threshold <- 3
data3$outlier_flag <- abs(data3$std_resid) > outlier_threshold

# Filter rows flagged as outliers
outliers <- data3 %>% filter(outlier_flag == TRUE)
print(outliers)

# Plot standardized residuals
ggplot(data3, aes(x = seq_along(std_resid), y = std_resid)) +
  geom_point(aes(color = outlier_flag), size = 2) +
  geom_hline(yintercept = c(-outlier_threshold, outlier_threshold), linetype = "dashed", color = "red") +
  labs(title = "Standardized Residuals with Outliers", x = "Index", y = "Standardized Residual") +
  theme_minimal()
```

Remove outliers 

```{r}
data3<-data3%>%
  filter(!outlier_flag == TRUE)
```

```{r}
hist(data3$value.mm3)
```

20 outlier points removed.  

### Analyze model 

Analyze mortality status effects. 

Plot raw data. 
```{r}
data3%>%
  ggplot(aes(x=time, y=value.mm3, colour=as.factor(status), group=interaction(date,sample)))+
  geom_point()+
  theme_classic()
```

Analyze change in fluorescence over time between temperatures.    

```{r}
model8<-lmer(sqrt(value.mm3) ~ time * as.factor(status) + (1|hardening:bag:sample) + (1|hardening), data=data3)

summary(model8)
anova(model8)
rand(model8)

qqPlot(residuals(model8))
```
 
Significant effect of mortality on metabolic rates when considering current status.  

Analyze effect of metabolic rates on the next mortality status (predicting mortality). 

```{r}
# Create a lagged status column
data3_lag <- data3 %>%
  group_by(paste(date, bag, sample)) %>%
  mutate(next_status = lead(status)) %>%
  ungroup()

#if final mortality at time point 4 = dead, then add 1 to the "next_status" column and if final.mortality = alive, then add 0 to the "next status" column 

data3_lag <- data3_lag%>%
  mutate(next_status = if_else(time=="4" & final.mortality =="dead", 1, 0))%>%
  select(!c("width.mm", "length.mm", "value", "volume.mm3", "raw_resid", "std_resid", "outlier_flag"))

# Logistic regression model
model9 <- glmer(next_status ~ scale(value.mm3) * temperature + (1|hardening:bag:sample) + (1|hardening), family = binomial(link = "logit"), data = data3_lag)

# Summary of the model
summary(model9)
Anova(model9)
```

Metabolic rate and temperature impact mortality status at the next time point. 

```{r}
plot(Effect(c("temperature"), model9))
```

Higher risk of mortality at 42°C. 

```{r}
plot(Effect(c("value.mm3"), model9))
```

Higher metabolic rate increases mortality risk. 

```{r}
plot(Effect(c("value.mm3", "temperature"), model9))
```

Risk of mortality is higher at eleveated metabolic rate in 42°C as compared to 18°C.  

### Plot data 

Plot effects on next mortality status. 

```{r}
# Logistic regression model for predictions
model_pred <- glmer(next_status ~ scale(value.mm3) * temperature + (1|hardening:bag:sample) + (1|hardening), family = binomial(link = "logit"), data = data3_lag)

# Generate predicted probabilities
data3_lag$predicted_mortality <- predict(model_pred, type = "response")

# Plot
plot12<-ggplot(data3_lag, aes(x = value.mm3, y = predicted_mortality, color = temperature, fill = temperature)) +
  geom_point(aes(y = next_status), alpha = 0.6, position = position_jitter(height = 0.03)) +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) +
  scale_colour_manual(values=c("cyan4", "orange"))+
  scale_fill_manual(values=c("cyan4", "orange"))+
  labs(
    title = "",
    x = expression(paste(Delta, " Fluorescence")),
    y = "Probability of Subsequent Mortality",
    color = "Temperature",
    fill = "Temperature"
  ) +
  theme_classic();plot12

ggsave(plot12, filename="figures/resazurin/mortality_predictions.png", width=6, height=5)
```






```{r}
plot14<-data3_lag%>%

  ggplot(aes(x=scale(value.mm3), y=next_status, color=temperature, fill=temperature))+
  geom_point(alpha=0.1, position=position_dodge(0.2))+
  scale_colour_manual(values=c("cyan4", "orange"))+
  scale_fill_manual(values=c("cyan4", "orange"))+
  theme_classic()+
  xlab("Scaled Metabolic Rate")+
  theme(
    legend.title=element_blank(),
    axis.text=element_text(size=14, colour="black"), 
    axis.title=element_text(size=14, face="bold", colour="black")
  );plot14

ggsave(plot14, filename="figures/resazurin/mortality_effects.png", width=5, height=5)
```


### Conduct posthoc tests 

#### Effects of temperature within time point
```{r}
anova(model6)

emm<-emmeans(model6, ~temperature|time, adjust = "tukey")
pairs(emm)
```

Metabolic rates are higher under 42°C in the first hour, and are lower afterwards.    

